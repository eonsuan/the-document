<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Document</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

  <!-- 이용 약관 -->

  <div id="terms" class="modal">
    <p>환영합니다<br>
      Welcome<br>
      Bienvenido<br>
      Bienvenue<br>
      Willkommen<br>
      ようこそ<br>
      Добро пожаловать<br>
      أهلاً وسهلا<br>
      ยินดีต้อนรับ<br>
      Chào mừng</p>
    <label><input type="checkbox" id="agree1" /> 네.</label><br><br>
    <p>The Document 이용약관<br><br>
      제1조 (목적) <br>
      본 약관은 The Document (이하 "당 플랫폼")가 제공하는 모든 서비스(이하 "서비스")의 이용조건 및 절차, 이용자와 당 플랫폼의 권리, 의무, 책임사항과 기타 필요한 사항을 규정함을 목적으로 한다.
      <br><br>
      제2조 (기대)<br>
      The Document는 다음과 같은 것들을 환영한다:<br>
      - 질문, 의심, 미완의 생각<br>
      - 인용, 비틀기, 재배열<br>
      - 서로 다른 언어적 기조의 나란한 공존<br>
      - 사적인 서사와 공적인 텍스트의 간섭<br>
      - 침묵이 아니라 중첩으로 이뤄진 응답<br>
      우리는 이곳이 하나의 커뮤니티가 아닌, 하나의 문서로 작동하기를 기대한다. 개별의 포스트는 없다. 글은 언제나 옆에, 혹은 아래에, 덧붙여질 뿐이다.
      <br><br>
      제3조 (회원 시스템)<br>
      당 플랫폼은 로그인, 팔로우, 좋아요 등의 전통적인 소셜 네트워크 기능을 제공하지 않는다. 사용자는 익명으로 글을 작성할 수 있으며, 관계는 사람 간이 아닌 텍스트 간의 연쇄와 교차를 통해 형성된다. 이러한 구조는 개인 중심의 표현이 아니라, 텍스트 그 자체의 힘과 맥락을 중심으로 하는 사유 중심의 네트워크를 지향한다.
      <br><br>
      제4조 (콘텐츠 접근 방식)<br>
      당 플랫폼은 콘텐츠 접근 방식에 있어 사용자의 선택을 전제하지 않는다. 특정 시간 간격으로 화면 상단에 제시되는 임의의 키워드를 통해, 사용자는 예기치 않은 사유의 접점을 만날 수 있다. 키워드를 선택하면 관련된 글들이 병렬적으로 연결되며, 이는 선형적 타임라인이 아닌, 다층적이고 비정형적인 관계 맺기 경험을 유도한다. 당 플랫폼은 기존 SNS의 시간성·개인화 알고리즘에서 벗어나, 우연성과 탐색성을 통해 사유의 확장을 도모한다.
      <br><br>
      제5조 (사용자 역할)<br>
      당 플랫폼은 개별 텍스트를 고립된 콘텐츠가 아닌, 상호작용하고 진화하는 사유적 생명체로 간주한다. 하나의 글은 언제나 다른 글에 반응하거나, 영향을 주고받으며, 의미는 고정되지 않고 맥락에 따라 유동한다. 이용자는 단독 저자가 아니라, 기존 사유 위에 덧붙이거나 비틀고 재배열함으로써 집단적 사유의 흐름을 함께 구성하는 협업적 작가로 기능한다.
      <br><br>
      제6조 (운영자의 의무)<br>
      당 플랫폼은 이용자가 안전하게 사유할 수 있는 문서 환경을 제공할 책임이 있으며, 이용자의 정보 보호와 콘텐츠 안전성을 보장한다. 그러나 사유적 윤리를 해치는 악의적 경우에는 최소한의 관리적 개입을 할 수 있다. 서비스 운영 중 장애나 보안 사고가 발생할 경우, 즉시 공지하고 복구 조치를 시행한다.
      <br><br>
      제7조 (면책 조항)<br>
      당 플랫폼은 이용자가 자율적으로 작성한 게시물에 대해 법적 책임을 지지 않으며, 분쟁 발생 시 당사자 간 해결을 원칙으로 한다. 플랫폼 이용 중 발생한 기술적 오류나 외부 침해에 대해선, 가능한 범위 내에서 신속한 복구와 피해 최소화를 위해 노력한다.
      <br><br>
      제8조 (약관의 효력 및 변경)<br>
      이 약관은 사이트 첫 방문 시 동의 절차를 거쳐 효력을 가지며, 약관 변경 시 사이트 내 공지를 통해 사전 공지하고, 변경 후에도 지속적으로 서비스를 이용하는 경우 동의한 것으로 간주한다.
      </p>
    <label><input type="checkbox" id="agree2" /> 네.</label>
  </div>

<!-- 홈 -->

  <div id="home">
    <div class="home-header">
      <div class="logo">
        <img src="./logo.png" alt="The Document Logo" />
      </div>
      <nav class="nav">
        <a href="#" id="about-button" class="floating-menu">About</a>
        <a href="#" id="community-button" class="floating-menu">Members</a>
        <a href="#" id="download-button" class="download-btn floating-menu">Download this document</a>
      </nav>            
    </div>

    <div id="document"></div>

    <div id="keyword-box" class="keyword-box"></div>

    <div class="input-box">
      <button class="add-button" id="add-entry">+</button>
      <input type="text" id="name-input" placeholder="Name" />
      <textarea id="message-input" placeholder="Type Anything"></textarea>
      <input type="file" id="image-input" accept="image/*" style="display: none;" />
      <button type="button" id="submit-entry">Submit</button>
    </div>
  </div>

  <div id="community-popup" class="popup">
    <div class="popup-header" id="community-drag">
      <span class="popup-title">Members</span>
      <button class="close-btn" id="close-community">x</button>
    </div>
    <div class="popup-scroll-area" id="community-list-container">
    </div>
  </div>
  
  <div id="about-popup" class="popup">
    <div class="popup-header" id="about-drag">
      <span class="popup-title">About</span>
      <button class="close-btn" id="close-about">x</button>
    </div>
  <div class="popup-content">
    <p>
      오늘날 인터넷 공간은 소수의 거대 플랫폼이 지배하고 있다. 페이스북, 인스타그램, 트위터와 같은 대형 소셜 미디어 플랫폼은 수십억 명의 사용자를 연결하며 이른바 ‘민주주의적 공론장’을 제공한다고 주장한다. 하지만 이러한 플랫폼들은 사용자의 데이터를 독점하고 알고리즘을 통해 정보를 필터링하며 광고 기반의 경제 시스템을 통해 거대한 수익을 창출한다. 그 결과, 우리의 관심사는 우리가 직접 선택하는 것이 아니라 플랫폼이 원하는 방향으로 유도되며, 알고리즘이 우리의 피드를 결정하는 구조가 형성되었다. 
      <br><br>
      The Document는 개인 중심의 계정, 팔로우, 좋아요 없이 작동하는 비정형적 텍스트 공간이다. 이곳에서는 글이 고립된 포스트가 아니라, 서로 얽히고 덧붙여지는 사유의 흐름으로 존재한다. 사용자는 특정 위치에 글을 삽입하거나 기존 텍스트와 중첩되도록 입력할 수 있으며, 이는 단선적 타임라인이 아닌 다층적 사유의 지형을 만들어낸다. 이 플랫폼은 알고리즘이 아니라 우연과 탐색을 중심으로 설계되었다. 상단에 무작위로 제시되는 키워드를 따라 사용자는 예상치 못한 텍스트들과 만나고, 의미의 경로는 언제나 분기하며 확장된다. 이러한 구조는 독자에게 수동적인 소비자가 아니라 능동적인 탐색자, 덧붙이는 저자로의 역할을 부여한다. 우리는 더 느리고 비효율적인, 그러나 더 사적인 연결과 더 깊은 사유를 믿는다.
    </p>
  </div>
</div>

  <div class="new-help-container">
    <img src="./new.png" alt="New Icon" class="floating-new-icon" />
    <div class="help-tooltip">
      처음이신가요?<br><br>
      하단에 위치한 입력창을 통해 텍스트와 이미지를 입력합니다. 입력을 마친 후에는 키보드의 Enter 키를 누르거나, Submit 버튼을 클릭하여 내용을 제출할 수 있습니다. 문서 상단에 마우스 커서를 올리면 ‘+’ 버튼이 표시됩니다. 이 버튼은 텍스트를 삽입할 위치를 지정할 수 있도록 도와주는 기능입니다. 원하는 위치의 ‘+’ 버튼을 클릭하면 해당 위치에 텍스트를 추가할 수 있습니다. 쓰고, 덧붙이고, 읽어보세요.
    </div>
  </div>

  <div class="page-gradient"></div>

  <div id="mobile">
    모바일 버전은 업데이트 중에 있습니다. <br>
    보다 나은 서비스를 위해 넓은 화면에서 접속해 주세요.
  </div>  

  <script src="script.js"></script>

<!-- 데이터연동 -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdv0FHFtBHUL9VWDRtvU1FXN8rAVwYgjo",
  authDomain: "the-document-94955.firebaseapp.com",
  projectId: "the-document-94955",
  storageBucket: "the-document-94955.appspot.com",
  messagingSenderId: "502838993401",
  appId: "1:502838993401:web:169c018782a315b05a5d28",
  measurementId: "G-H8CMBQBWXD"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

const db = getFirestore(app);
const storage = getStorage(app);
const entries = collection(db, "doc");

const submitButton = document.getElementById("submit-entry");
const nameInput = document.getElementById("name-input");
const messageInput = document.getElementById("message-input");
const imageInput = document.getElementById("image-input");
const documentDiv = document.getElementById("document");
const communityContainer = document.getElementById("community-list-container");
const keywordBox = document.getElementById("keyword-box");

let selectedInsertTarget = null;
let keywordIntervalStarted = false;

const singleEntry = document.createElement("span");
singleEntry.className = "entry";
singleEntry.dataset.nickname = "shared";
documentDiv.appendChild(singleEntry);

const nicknameSet = new Set();
const nicknameList = document.createElement("div");
nicknameList.style.padding = "10px";
nicknameList.style.margin = "0";
nicknameList.style.listStyle = "none";
nicknameList.style.fontSize = "1.1rem";
nicknameList.style.display = "flex";
nicknameList.style.flexDirection = "column";
communityContainer.innerHTML = "";
communityContainer.appendChild(nicknameList);

function renderEntry(data) {
  const entryWrapper = document.createElement("span");
  entryWrapper.className = "entry";
  entryWrapper.dataset.nickname = data.name;

  const insertBtn = document.createElement("button");
  insertBtn.textContent = "+";
  insertBtn.className = "insert-button";

  insertBtn.addEventListener("click", () => {
    if (selectedInsertTarget) {
      selectedInsertTarget.classList.remove("insert-target");
    }
    selectedInsertTarget = entryWrapper;
    entryWrapper.classList.add("insert-target");
  });

  if (data.message) {
    const textSpan = document.createElement("span");
    textSpan.className = "entry-text";
    textSpan.textContent = data.message + " ";
    entryWrapper.appendChild(textSpan);
  }

  if (data.imageUrl) {
    const img = document.createElement("img");
    img.src = data.imageUrl;
    img.className = "inline-img";
    entryWrapper.appendChild(img);
  }

  entryWrapper.appendChild(insertBtn);
  singleEntry.appendChild(entryWrapper);

  if (!nicknameSet.has(data.name)) {
    nicknameSet.add(data.name);
    const div = document.createElement("div");
    div.textContent = data.name;
    nicknameList.appendChild(div);
  }
}

submitButton.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  const message = messageInput.value.trim();
  const file = imageInput.files[0];

  if (!name || (!message && !file)) return;

  let imageUrl = "";

  try {
    if (file) {
      const storageRef = ref(storage, `images/${Date.now()}_${file.name}`);
      const snapshot = await uploadBytes(storageRef, file);
      imageUrl = await getDownloadURL(snapshot.ref);
      console.log("✅ 이미지 업로드 성공:", imageUrl);
    }

    await addDoc(entries, {
      name,
      message,
      imageUrl, // ← 이 부분 중요!
      timestamp: Date.now()
    });
    console.log("✅ Firestore 저장 성공");

    // 입력창 초기화
    nameInput.value = "";
    messageInput.value = "";
    imageInput.value = "";
  } catch (error) {
    console.error("🚨 오류 발생:", error);
  }
});

const q = query(entries, orderBy("timestamp"));
onSnapshot(q, (snapshot) => {
  singleEntry.innerHTML = "";
  snapshot.forEach(doc => renderEntry(doc.data()));
  extractKeywords();

  if (!keywordIntervalStarted) {
    keywordIntervalStarted = true;
    setInterval(extractKeywords, 10000);
  }
});

function extractKeywords() {
  const text = singleEntry.textContent;
  const words = text.match(/\w+|[가-힣]{2,}/g) || [];
  const stopwords = ['그리고', '하지만', '있다', '입니다', '있는', '하는', '그', '이', '저', '것', '에서'];
  const filtered = words.filter(w => !stopwords.includes(w));

  if (filtered.length === 0) {
    animateKeyword("");
    clearHighlights();
    return;
  }

  const shuffled = filtered.sort(() => 0.5 - Math.random());
  const sample = shuffled.slice(0, 3);
  animateKeyword(sample.join(" "));
  highlightKeywords(sample);
}

function highlightKeywords(keywords) {
  clearHighlights();
  const walker = document.createTreeWalker(singleEntry, NodeFilter.SHOW_TEXT);
  const nodesToReplace = [];

  while (walker.nextNode()) {
    const node = walker.currentNode;
    const parent = node.parentNode;
    if (parent.nodeName === "MARK") continue;

    let replaced = node.textContent;
    let matched = false;

    keywords.forEach(word => {
      const regex = new RegExp(`(${word})`, "g");
      if (regex.test(replaced)) {
        matched = true;
        replaced = replaced.replace(regex, `<mark class=\"keyword-highlight\">$1</mark>`);
      }
    });

    if (matched) {
      const span = document.createElement("span");
      span.innerHTML = replaced;
      nodesToReplace.push({ oldNode: node, newNode: span });
    }
  }

  nodesToReplace.forEach(({ oldNode, newNode }) => {
    oldNode.parentNode.replaceChild(newNode, oldNode);
  });
}

function clearHighlights() {
  document.querySelectorAll(".keyword-highlight").forEach(el => {
    el.outerHTML = el.innerText;
  });
}

function animateKeyword(text) {
  keywordBox.innerHTML = "";
  if (!text.trim()) {
    keywordBox.textContent = " ";
    return;
  }

  const words = text.split(" ");
  words.forEach((word, i) => {
    [...word].forEach(char => {
      const span = document.createElement("span");
      span.className = "floating-char";
      span.textContent = char;
      span.style.animationDelay = `${Math.random()}s`;
      keywordBox.appendChild(span);
    });

    if (i < words.length - 1) {
      const spacer = document.createElement("span");
      spacer.innerHTML = "&nbsp;&nbsp;&nbsp;";
      keywordBox.appendChild(spacer);
    }
  });
}
</script

</body>
</html>
